# **条件编译（Conditional Compilation）**

---

## 0. 从C预处理器角度看预定义

预处理器在处理标识符时，遵循与C相同的规则

当预处理器在预处理指令中发现一个标识符时，它会把该标识符当做**已定义的**或**未定义的**，**<u>注意这里的已定义指的是有预处理器定义</u>**

+ 如果标识符时同一个文件中由前面的 #define 指令创建的宏名，而且没有用 #undef 指令关闭，那么该标识符时已定义的

+ 如果标识符不是宏，那么该标识符对预处理器而言就是未定义的

~~~C
#define LIMIT 100  // LIMIT是已定义的
#define X          // X是已定义的
#define A(X) X*X   // A是已定义的
#undef X           // X是未定义的
int n;             // n是未定义的
~~~

---

## 1. #undef 指令

**#undef** 指令作用是取消已定义的 #define 指令

如果想使用一个宏，又不确定之前是否使用过，为安全起见，可以用 #undef 指令取消该名字的定义

#define 宏的作用域从它在文件中的声明处开始，直到 #undef 取消宏为止，或延伸到文件尾

~~~C
#define MACRO 1

int main()
{
    程序段1;
    #undef MACRO;  //移除MACRO的定义
    程序段2;
}
// MACRO的定义只在程序段1中有效
~~~

---

## 2. #ifdef、#else、#endif 指令

~~~C
#ifdef 标识符
 	程序段1
#else
	程序段2
#endif

// 程序段可以是预处理指令或C代码
~~~

#ifdef 指令说明，若预处理器已定义了后面的标识符，则执行 #ifdef 和 #else 之间的所有指令或编译它们之间的所有代码

若预处理器未定义后面的标识符，则执行 #else 和 #endif 之间的所有指令或编译它们之间的所有代码

**注意：#else 不是必要的，但 #endif 是 <u>必须存在</u> 的**

~~~C
#ifdef 标识符
	程序段
#endif
~~~

用处：

(1) 如果一个C源程序在不同的计算机系统上运行，而不同的计算机又有一定的差异（例如存放int型变量所用的字节数）

这样在不同的计算机上编译运行同一个程序时就需要对源程序进行修改，因此降低了程序的通用性

可以通过下面的条件编译来处理：

~~~C
#ifdef COMPUTER_A
	#define INTEGER_SIZE 4
#else 
	#define INTEGER_SIZE 2
#endif
~~~

(2) **在调试程序时，常常希望输出一些需要的信息（中间值）来分析程序，而在调试完成之后不再需要这些信息，可以通过增加条件编译段来辅助调试**

例如：

~~~C
#include <stdio.h>
#define DEBUG

int main()
{
    int i;
    int total = 0;
    for(i = 0; i < 10; i++)
    {
        total = total + i*i;
    /*----------辅助调试的条件编译段-----------*/
       	#ifdef DEBUG
        	printf("i=%d total=%d\n", i, total);
        #endif
    /* -------------------------------------- */
    }
    printf("total = %d\n", total);
    
    return 0;
}
~~~

**在调试结束后，可以移除 DEBUG ，这样程序中所有的辅助调试的语句全部都不会起作用，起到统一调控的作用**

**如果以后还需要用到这些中间值，只要再次添加 DEBUG，省去了再次写输出语句的麻烦**

---

## 3. #ifndef 指令

**#ifndef** 指令与 #ifdef 类似，可以与 #else、#endif 一起使用，只是它们的逻辑相反

#ifndef 指令作用是判断后面的标识符是否是未定义的，如果是未定义的就执行相应的指令或编译相应的代码，常用于定义之前未定义的常量

~~~C
#ifndef 标识符
	程序段1
#else 
	程序段2
#endif
~~~

~~~C
#ifndef 标识符
	程序段
#endif
~~~

+ **通常，包含多个头文件时，其中的文件可能包含了相同的宏定义**

  **#ifndef 指令可以防止相同的宏被重复定义**

  **在 <u>首次</u> 定义一个宏的头文件中用 #ifndef 激活定义，随后<u>在其他头文件中的定义都会被忽略</u>**

~~~C
#ifndef 标识符
	#define 标识符
#endif
~~~

+ **#ifndef 指令还可以用于防止头文件被重复引用，即在一个源文件中多次包含同一个文件**

  这通常是由于 #include 嵌套引起的

~~~C
#include "a.h"
#include "b.h"
// a.h文件中已经包含了b.h
// 造成了b.h重复引用
~~~

​	**有些头文件重复包含，会引起错误，比如在头文件中定义了全局变量(虽然这种方式不被推荐，但确实是C规范允许的)这种会引起重复定义**，**当然也会增加编译工作的工作量**

**<u>养成一个良好的编程习惯是重要的，在头文件定义时，应该使用 #ifndef / #define / #endif 的格式</u>**

定义一个头文件，一般的格式是这样的：

~~~C
#ifndef 标识符
#define 标识符
程序段
#endif
~~~

**为了确保代表该头文件的标识符没有在别处定义，通常，有如下规则：**

<u>**用文件名作为标识符，其中的字母全部大写、用下划线代替文件名中的点、可以使用下划线作为前缀或后缀**</u>

~~~C
/* stdio.h中的代码 */
#ifndef _STDIO_H
#define _STDIO_H
文件内容
#endif
~~~

需要注意的是，由于标准保留使用下划线作为**<u>前缀</u>**，所以在自己的代码中不要这样写，以免与标准头文件中的宏发生冲突

---

## 4. #if、#elif 指令

**#if** 指令后跟整型常量表达式，如果表达式非零，则表达式为真。可以在指令中使用C的关系运算符和逻辑运算符

#elif 类似于 else if，后面跟的表达式与 #if 相同

**#if 可以与 #else、#elif 一起使用，与 #ifdef、#ifndef 相同的是末尾的 #endif 是必不可少的**

~~~C
#if 表达式1
	程序段1
#elif 表达式2
	程序段2
#else 
	程序段3
#endif
~~~

**可以使程序移植性更强，适用于不同的系统和计算机：**

~~~C
#if SYS == 1
	#include "a.h"
#elif SYS == 2
	#include "b.h"
#elif SYS == 3
	#include "c,h"
#else 
	#include "d.h"
#endif
~~~



