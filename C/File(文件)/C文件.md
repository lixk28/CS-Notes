# **文件(File)**

---

## 1. 文件的含义

文件有不同的类型，在程序设计中主要用到两种文件：

1. **程序文件**：包括源程序文件（.c）、目标文件（.obj）、可执行文件（.exe）等

   ​                  这些文件的内容是程序代码

2. **数据文件**：数据文件的内容不是程序，而是程序运行时读写的数据

   ​                  从键盘上输入的数据，从显示器上输出的数据

实际上，常常需要将一些数据（运行的最终结果或中间数据）输出到磁盘上保存起来，以后需要时再从磁盘中输入到计算机内存，这就要用到**磁盘文件**。

为了简化用户对输入输出设备的操作，使用户不必去区分各种输入输出设备之间的区别，**操作系统把各种设备都同一作为文件来处理**。从操作系统的角度看，每一个与主机相连的输入输出设备都是一个文件。终端键盘是输入文件，显示器和打印机是输出文件。

所谓***文件***一般指**存储在外部介质上数据的集合**。一组数据是以文件的形式存放在外部介质（如磁盘）上的。

**操作系统是以文件为单位对数据进行管理的，文件是由操作系统统一进行管理的**。如果要寻找存放在外部介质上的数据，要先按文件名找到指定的文件，然后再从该文件中读取数据；如果要在外部介质上存储数据，也必须先建立一个文件，才能向它输入数据。

**数据的输入和输出是数据传送过程**，数据像水流一样从一处流向另一处，因此常将输入和输出形象地称为**流**（stream），即**数据流**。流表示了数据/信息从**源**到**目的**端的流动。在输入操作时，数据从文件流向计算机内存；在输出操作时，数据从计算机流向文件。

**C语言把文件看做一个字符（或字节）的序列**，即由若干个字符（字节）的数据顺序组成。**一个输入输出流就是一个字符流或字节流（二进制码）**。

C的数据文件由一连串的字符（字节）组成，而不考虑行的界限，两行数据间不会自动加分隔符，对文件的存取是以字符（字节）为单位的。输入输出数据流的开始和结束仅受程序控制而不受物理符号的控制，这增加了处理的灵活性。这种文件称为**流式文件**。

---

## 2. 文件名

一个文件要有一个**唯一**的**文件标识**，以便用户识别和引用。

**文件标识包括三个部分：(1)文件路径  (2)文件名主干  (3)文件后缀**

例如   <u>D: \CC \ temp \</u>     <u>file1</u>     .      <u>dat</u>

​             文件路径       文件名主干    文件后缀

表示 file1.dat 文件存放在D盘中的CC目录下的temp子目录下

文件标识常被称为**文件名**，要注意**文件名不仅仅指的是文件名主干**，而包括了以上的三部分内容

**文件名主干的命名规则遵循标识符的命名规则，文件后缀则表示文件的性质**

doc : Word生成的文件

ppt : 幻灯片文件

txt : 文本文件

**dat : 数据文件**

**c : C源程序文件**

**cpp ：C++源程序文件**

obj : 目标文件

exe : 可执行文件

---

## 3. 文件的分类

根据数据的组织形式，数据文件分为**ASCII文件**和**二进制文件**

> ASCII文件又称**文本文件(text file)**，每一个字节存放一个字符的ASCII码

> 二进制文件又称**映像文件(image file)**，数据在内存中是以二进制存储的，如果不加转换直接输出到外存，就是二进制文件，可认为它就是存储在内存的数据的映像

数据在磁盘上的存储方式：**字符型数据一律以ASCII码形式存储，数值型数据既可以用ASCII码形式存储，也可以用二进制形式存储**。

例如，整数10000在内存中的存储形式为：00000000 00000000 00100111 00010000

如果用ASCII码形式输出到磁盘上，则在磁盘中占5个字节：00110001 00110000 00110000 00110000 00110000

如果用二进制形式输出到磁盘上，则在磁盘中占4个字节：00000000 00000000 00100111 00010000

> 用ASCII码形式输出时字符与字节一一对应，一个字节的内容代表一个字符，因而便于对字符进行逐个处理，也便于输出字符。但一般占用的存储空间较多，而且要花费转换时间（二进制与ASCII码之间的转换）

> 用二进制形式输出数据，可以节省外存空间、减少转换时间，把内存中的内容原封不动地输出到磁盘上，此时一个字节并不一定代表一个字符

如果程序运行过程中有的中间数据需要保存到外部介质中，以便在需要时在输入到内存，一般用二进制文件比较方便

---

## 4. 缓冲区(Buffer)

### 4.1 缓冲区的含义

ANSI C标准采用缓冲文件系统处理数据文件

**缓冲文件系统**是指系统自动地在内存区为程序中每一个正在使用的文件开辟一个**文件缓冲区**。

**缓冲区**又称为**缓存**，它是**内存空间的一部分**，**缓冲区本质上就是一块内存**。也就是说，在内存空间中预留了一定的存储空间，这些存储空间用来缓冲输入或输出的数据，这部分预留的空间就叫做缓冲区。

缓冲区根据其对应的是输入设备还是输出设备，分为**输入缓冲区**和**输出缓冲区**。

### 4.2 缓冲区的工作原理和作用

1. **缓冲区的工作原理**

  从内存向磁盘输入数据（就是输入数据），并不是程序中每执行一句输入语句(scanf、gets、getchar等)，就从键盘输入数据，再把这一次输入的数据读入磁盘（这样每一次输入都要读入一次磁盘），**而是将从键盘上输入的数据全部存储在缓冲区中，再把缓冲区中所有的数据一次读入磁盘中。**

  从磁盘向内存输出数据（就是输出数据），并不是程序中每执行一句输出语句(printf、puts、putchar等)，就从磁盘中取出一部分数据，再输出数据，**而是先把磁盘中要读出的数据全部存储在缓冲区中，再从缓冲区逐个地将数据送到程序数据区，然后依次输出。**

2. **缓冲区的作用**

   (1)使得低速的输入输出设备和高速的CPU能够协调工作，避免低速的输入输出设备占用CPU，解放出CPU，使其能够高效率工作。减少实际的物理读写次数。

   (2)缓冲区在创建时就被分配内存，这块内存区域一直被重用，可以减少动态分配和回收内存的次数。

   > 举个简单的例子，比如A地有1w块砖要搬到B地
   >
   > 由于没有工具（缓冲区），我们一次只能搬一本，那么就要搬1w次（实际读写次数）
   >
   > 如果A，B两地距离很远的话（IO性能消耗），那么性能消耗将会很大
   >
   > 但是要是此时我们有辆大卡车（缓冲区），一次可运5000本，那么2次就够了
   >
   > 相比之前，性能肯定是大大提高了。
   >
   > 而且一般在实际过程中，我们一般是先将文件读入内存，再从内存写出到别的地方
   >
   > 这样在输入输出过程中我们都可以用缓存来提升IO性能。

***每一个文件在内存中只有一个缓冲区***：在向文件输出数据时，它就作为输出缓冲区；在从文件输入数据时，它就作为输入缓冲区。

![](C:\Users\Lenovo\Desktop\Note\images\文件缓冲区.png)

* *文件缓冲区存在的验证*

  ~~~C
  #include<stdio.h>
  #include<string.h>
  #include<stdlib.h>
  #define MAX_SIZE 100
  
  int main()
  {
  	char *str=(char *)malloc(sizeof(char)*MAX_SIZE);
  	char c;
  	
  	printf("请设置密码:\n");
  	scanf("%s", str);
  	printf("请确认密码(Y/N):\n");
  	c = getchar();
  	if(c == 'Y')
  		printf("1\n");
  	else 
  		printf("2\n");
  		
  	return 0;
  }
  ~~~

  当你输入一串字符串（如abcdef）并按下回车后，你以为接下来要输入Y/N时，这个代码实际直接结束了，跳过了输入这个字符的环节，直接输出了2

  原因：![](C:\Users\Lenovo\Desktop\Note\images\文件缓冲区.png)

  自己可以解决这个bug，可以在之前再加一个getchar，也可以自行清空缓冲区：

  ~~~C
  while (getchar() != '\n') //在getchar()之前获取完缓冲区中所有的字符
  	continue;
  ~~~

## 5. 文件类型指针

每个被使用的文件都在内存中开辟一个相应的文件信息区，用来存放文件的有关信息，这些信息是保存在一个结构体变量中的，该结构体类型是由系统声明的，取名为**FILE**。

如一种C编译环境提供的stdio.h头文件中有以下的文件类型声明：

~~~C
typedef struct
{
    short level;       	  	 //缓冲区的状态(空/满)
    unsigned flags;      	 //文件状态标志
    char fd;             	 //文件描述符
    unsigned char hold; 	 //缓冲区为空不读取字符
    short bszie;        	 //缓冲区的大小
    unsigned char *buffer;   //数据缓冲区的位置
    unsigned char *curp;     //文件位置标记指针当前的指向
    unsigned istemp;         //临时文件指示器
    short token;             //用于有效性检查
}FILE;
~~~

不同的编译系统的FILE类型包含的内容不完全相同，但大同小异。从以上可以看出，FILE是结构体类型自行命名的数据类型名称，FILE与上面的结构体类型等价。

**声明FILE结构体类型的信息都包含在头文件stdio.h中，在程序中可以直接用FILE类型名定义变量。**

可以定义FILE类型的变量：

~~~C
FILE f1; //定义了一个结构体变量f1，可以用它来存放一个文件的有关信息
~~~

一般不定义FILE类型的变量，而是设置一个指向FILE类型变量的指针变量，通过指针变量来引用FILE类型的变量，这样使用比较方便。

~~~C
FILE *fp; //定义了一个指向FILE型数据的指针变量
~~~

可以使fp指向某一个文件的文件信息区（即一个结构体变量），通过该文件的文件信息区就可以访问该文件

通常将**指向文件信息区的指针变量**简称为**指向文件的指针变量**

**注意：指向文件的指针变量并不是指向外部介质上的数据文件，而是指向内存中的文件信息区（本质上是一个指向结构体变量的指针变量，只是指向的结构体变量中存储的是文件信息）**

