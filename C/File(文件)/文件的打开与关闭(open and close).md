# **文件的打开与关闭(open and close)**

---

在对文件进行一些操作之前（读写），需要先**打开**文件，在使用文件之后，应该**关闭**文件。

***打开文件*** 指的是 **为文件建立相应的文件信息区（存放文件的有关信息）和文件缓冲区（暂时存放输入输出的数据）**

***关闭文件*** 指的是 **撤销文件信息区和文件缓冲区，使文件指针变量不再指向该文件**

## 1. **用fopen函数打开数据文件**

ANSI C规定了用标准输入输出函数fopen来打开文件，fopen函数是stdio.h头文件中包含的函数

**fopen函数原型：**

~~~C
FILE * fopen(const char * path, const char * mode);
~~~

**fopen函数所在库：<stdio.h>**

**fopen函数功能：打开一个文件**

**fopen函数返回值：若文件成功打开，返回该文件的地址值（FILE *)；若文件打开失败，返回NULL**

**fopen函数参数：第一个参数是文件名（包括文件路径、文件名称和文件后缀3个部分！）**

​						    **第二个参数是文件的使用方式（读、写、追加等）**  

​							写入的两个参数都是字符串常量

**fopen函数的调用方式一般为：**

~~~C
FILE * fp; //先定义一个文件指针变量
fp = fopen(文件名，使用文件的方式); //再利用fopen函数使fp指向某个文件
~~~

常用下面的方法打开一个文件：

~~~C
if( (fp=fopen("D:\\CC\\file.dat","r")) == NULL)
{
    printf("Cannot open this file!\n");
    exit(0);
}
~~~

***注意***：<u>本来文件名应该写成 "D:\\\\CC\\\file.dat"，但由于C语言吧 '\\' 作为转义字符的标志，因此在字符串或字符中要表示 '\\' 		时，应当在 '\\' 之前再加一个 '\\'</u> 

即先检查打开文件的操作是否出错，如果出错就在终端上输出 Cannot open this file!

exit函数作用是关闭所有文件，终止正在运行的程序，待用户检查出错误后，修改后重新运行

## 2. 文件的使用方式

|      文件的使用方式      |                     含义                      | 若指定的文件不存在 |
| :----------------------: | :-------------------------------------------: | :----------------: |
|      r（只读 read）      |        为了输入数据，打开一个文本文件         |        出错        |
|     w（只写 write）      |   为了输出数据，**<u>打开</u>**一个文本文件   |     建立新文件     |
|     a（追加 append）     |             向文本文件尾添加数据              |        出错        |
|  rb（只读 read binary）  |       为了输入数据，打开一个二进制文件        |        出错        |
| wb（只写 write binary）  |  为了输出数据，**<u>打开</u>**一个二进制文件  |     建立新文件     |
| ab（追加 append binary） |            向二进制文件尾添加数据             |        出错        |
|        r+（读写)         |         为了读和写，打开一个文本文件          |        出错        |
|        w+（读写）        |  为了读和写，<u>**建立**</u>一个新的文本文件  |     建立新文件     |
|        a+（读写）        |         为了读和写，打开一个文本文件          |        出错        |
|       rb+（读写）        |        为了读和写，打开一个二进制文件         |        出错        |
|       wb+（读写）        | 为了读和写，<u>**建立**</u>一个新的二进制文件 |     建立新文件     |
|       ab+（读写）        |        为了读和写，打开一个二进制文件         |        出错        |

### 2.1  用 r w a 方式打开文件

+ 以 r 方式打开的文件只能用于向计算机输入而不能用来向该文件输出数据，而且该文件应该已经存在，并存有数据，这样程序才能从文件中读取数据。不能以r方式打开一个不存在的文件，否则出错。

+ 以 w 方式打开的文件只能用于向该文件写数据，而不能用来向计算机输入数据。若原来不存在该文件，则在打开文件前新建立一个以特定的名字命名的文件；若原来已存在一个以该文件名命名的文件，则在打开文件前先将该文件删去，然后重新建立一个新文件。

+ 以 a 方式打开的文件只能用于向文件末尾添加新的数据（不删除原有数据），而且该文件应该已经存在。打开文件时，**文件读写位置标记移动到文件末尾**。不能以a方式打开一个不存在的文件，否则出错。

### 2.2 用 r+ w+ a+ 方式打开文件

+ 用 r+ 方式打开文件时：(1)若文件存在，打开文件，**文件读写位置指针重新定位到文件头**，**<u>但不清空文件内容</u>**

  ​        							  (2)若文件不存在，报错文件不存在

+ 用 w+ 方式打开文件时：(1)若文件存在，打开文件，**文件读写位置指针重新定位到文件头，<u>并清空文件内容</u>**

  ​										（实际上是创建一个新文件，把原文件覆盖了，作用相当于清空文件内容）

  ​									   (2)若文件不存在，则创建以输入的文件名命名的新文件 

+ 用 a+ 方式打开文件时：(1)若文件存在，打开文件，**读指针定位到文件头，写指针定位到文件尾**，<u>**且不清空文件内容**</u>

  ​									   (2)若文件不存在，报错文件不存在

### 2.3**带b和不带b的唯一区别：<u>对换行的处理</u>**

+ **在C语言中，一个回车 '\n' 即可实现换行**

+ **在Windows系统中，必须要用回车 '\r' 和换行 '\n' 两个字符才能实现换行**

> 如果使用的是文本文件并且用 w 方式打开，在向文件输出时，遇到换行符 '\n' 时，系统就把它转换为 '\r' 和 '\n' 两个字符，否则在Windows系统中查看文件时，文件中的内容全部连成一行，无法阅读

   > 如果使用的是文本文件并且用 r 方式打开，在从文件读入时，遇到 '\r' 和 '\n' 两个连续的字符时，系统就把它们转换为 '\n' 一个字符

   > 如果使用的是二进制文件，在向文件读写时，不需要进行这种转换，加 b 表示使用的是二进制文件，系统就不进行转换

   **在打开一个输出文件时，是选 w 还是 wb 方式，完全根据需要，如果需要对回车符进行转化的，就用 w；如果不需要转换的，就用 wb**

---

## 3. 用fclose函数关闭数据文件

在使用完一个文件后应该关闭，以防止它再次被误用。

**关闭文件**指的是撤销文件信息区和文件缓冲区，使文件指针变量不再指向该文件。

**fclose函数原型：**

~~~C
int fclose(FILE *fp);
~~~

**fclose函数所在库：<stdio.h>**

**fclose函数功能：关闭一个文件**

**fclose函数返回值：若关闭成功，返回 0；若关闭失败，返回 EOF(-1)**

**fclose函数参数：一个文件指针变量**

**fclose函数调用的一般形式：**

~~~C
fclose(fp); //fp为文件指针变量
~~~

常用下面的方法关闭一个文件：

~~~C
if(fclose(fp) != 0)
{
    printf("Error in closing this file!\n");
    exit(0);
}
~~~

如果磁盘已满、I/O错误，都会导致 fclose 函数调用失败

因为在向文件写数据时，是先将数据输出到缓冲区，待缓冲区充满后再输出给文件

如果当数据未充满缓冲区时程序结束运行，就有可能使缓冲区中的数据丢失

**fclose函数在关闭文件时，先把缓冲区内的数据输出到磁盘文件，然后才撤销文件信息区**