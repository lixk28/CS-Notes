# 随机读写数据文件

---

## 1. 文件读写位置标记

为了对文件进行控制，系统为每个文件设置了一个**文件读写位置标记**（简称**文件位置标记**或**文件标记**），**用来指示下一个被读写的字节的位置**

也称为**文件位置指针**或**文件指针**

一般情况下，在对文件进行顺序读写时，文件位置标记指向文件开头

若对文件进行读的操作，每读取一个字符后，文件位置标记就向后移动一个位置，依次类推，遇到文件尾结束

若对文件进行写的操作，每写完一个数据后，文件位置标记就向后移动一个位置，依次类推，数据写完后文件位置标记在最后一个数据之后

**也就是说，读写操作都会改变文件位置标记的指向**

<img src="E:\.workspace\Note\C\images\文件读写位置标记.png" style="zoom: 67%;" />

可以根据读写的需要，人为地移动文件位置标记的位置，可以前移、后移、移到文件头或文件尾，这就是所谓的**随机读写**

对流式文件既可以进行顺序读写，也可以进行随机读写，**关键在于控制文件位置标记**

---

## 2. 文件读写位置标记的定位

可以强制使文件位置标记指向指定的位置

### 2.1 用 rewind 函数使文件位置标记指向文件开头

rewind函数原型：

~~~C
void rewind(FILE *fp);
~~~

rewind函数所在库：<stdio.h>

rewind函数功能：(1)**使 fp 指向的文件的读写位置标记重新指向文件开头**

​					        (2)**<u>同时使 feof 函数的值恢复为 0</u>**

rewind函数参数及返回值：fp 是文件指针，rewind函数没有返回值

rewind函数调用的一般方式：

~~~C
rewind(fp);
~~~

---

### 2.2 用 fseek 函数改变文件位置标记的指向

fseek函数原型：

~~~C
int fseek(FILE *fp, long offset, int fromwhere);
~~~

fseek函数所在库：<stdio.h>

fseek函数功能：使 fp 指向的文件的读写位置标记的指向改变到指定位置

fseek函数返回值：若函数执行成功，返回 0

​							  若函数执行失败，返回 非零值，并设置error值，可用ferror检测错误

**fseek函数参数：**fp 为文件指针，指向被改变的文件

​							<u>**offset (偏移)** 是文件位置标记相对于 fromwhere 的**偏移量**，是long型数据且以字节为单位</u>

​							（offset 为正代表后移，为负代表前移）

​							<u>**fromwhere (起始位置)** 是指定的**起始点**，声明文件位置标记偏移的基点</u>

​	<u>**fseek移动文件位置指针的计算方法与数组相同**</u>：若 offset 为0，fromwhere为 1，则文件位置指针不移动，依次类推

**fromwhere 有C标准指定的名称：**

|         起始点         |   名称   | 数值代表 |
| :--------------------: | :------: | :------: |
|         文件头         | SEEK_SET |    0     |
| 读写位置标记的当前位置 | SEEK_CUR |    1     |
|         文件尾         | SEEK_END |    2     |

**注意：文件尾指的是最后一个字节的后面，并不是最后一个字节！**

**fseek的一般调用方式：**

~~~C
fseek(fp,nL,0/1/2 or SEEK_SET/SEEK_CUR/SEEK_END); 
// fp指向需要被改变的文件
// n是一个数字，代表偏移量，后面加一个字母L，表示是long型
// 0/1/2 或 SEEK_SET/SEEK_CUR/SEEK_END 代表偏移量的起始点
~~~

例如：

~~~C
fseek(fp,100L,0); //将文件位置标记向后移动到离文件头100个字节处

fseek(fp,-50L,2); //将文件位置标记向前移动到离文件尾50个字节处

fseek(fp,10L,1); //将文件位置标记向后移动到离当前位置10个字节处
~~~

~~~C
fseek(fp,0,0); //等价于rewind(fp)

fseek(fp,0,2); //将文件位置标记移动到文件尾
~~~

**fseek一般用于二进制文件**，用于文本文件不能确保结果符合预期

---

### 2.3 用 ftell 函数测定文件位置标记当前的位置

ftell 函数原型：

~~~C
long ftell(FILE *fp);
~~~

ftell 函数所在库：<stdio.h>

ftell 函数功能、参数及返回值：得到 fp 指向的文件的文件位置标记的位置  

​												**若函数执行成功，返回文件位置指针当前位置相对于文件头的偏移<u>字节数</u>**

​												**若函数执行失败，返回 -1L**

​										 <u>**ftell计算位置的方法与数组相同**</u>：若文件位置指针当前指向文件头，返回值为0，依次类推

ftell 一般调用形式：

~~~C
long cur;
cur = ftell(fp); // cur存放文件位置指针当前位置
~~~

**ftell 常常用来获取文件的长度（总共占的字节数）：**

~~~C
long flen;
fseek(fp,0L,SEEK_END); //使文件位置指针指向文件尾
flen = ftell(fp); //获取文件的总字节数flen
~~~