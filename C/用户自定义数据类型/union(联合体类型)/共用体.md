# **共用体类型**

***

*可以用同一段内存单元存放不同类型的变量，这些变量都从同一地址开始存放*

*几个变量共享同一段内存的结构，称为**共用体**类型的结构*

---

## 1. 共用体类型变量的定义

*定义共用体类型变量的一般形式为：*

~~~C
union 共用体名{ //这是声明了一个共用体类型
    成员表列
};  //分号不能省 ！！！

union 共用体名
{
    成员表列
}变量表列;  //在声明的同时定义变量

union 共用体名
{
    成员表列
};
union 共用体名 变量名; //当然也可先声明再定义变量

typedef union 共用体名
{
    成员表列
};
共用体名 变量名;//typdef同样可以用在共用体上
~~~

---

## 2. 共用体变量的初始化

可以对共用体变量初始化，***但初始化列表中只能有一个常量***

~~~C
union data
{
    int n;
    char ch;
    float f;
}a={1,'A',1.0};  //不能同时对多个成员初始化，因为它们占用同一段内存单元

union data b={1}; //正确，对第一个成员初始化

union data c={.ch='A'}; //C99允许对指定的一个成员初始化
~~~

---

## 3. 共用体变量的引用

<u>*不能引用共用体变量，而只能引用共用体变量中的成员</u>，使用成员运算符 . 来引用共用体变量中的成员*

~~~C
union Data
{
    int n;
    char c;
}a;

// 不能只引用共用体变量，下面的引用是错误的
printf("%d",a);
// 因为a的存储区可以按不同的类型存放数据，不同类型的数据需要占用不同的内存长度
// 只写共用体变量名，系统无法知道应该输出哪一个成员的值

// 只能引用共用体变量中的成员，下面的引用是正确的
printf("%d",a.n);
printf("%c",a.c);
~~~

---

## 4. 共用体类型数据的特点

### 4.1 共用体变量及其成员地址

***共用体变量的地址和它各成员的地址相同***

~~~C
union data
{
    int i;
    char ch;
    float f;
}a;

printf("%p",&a);
printf("%p",&a.i);
printf("%p",&a.ch);
printf("%p",&a.f);  //地址值都是相同的
~~~

---

### 4.2 共用体变量占用的内存长度

共用体变量中不同的成员占用同一段内存，因此<u>***共用体变量所占的内存长度等于最长的成员的长度***</u>

~~~C
union data
{
    int i;
    char c;
    float f1;
    double f2;
}a;

// a所占的内存长度是8字节 而不是4+1+4+8=17字节
// sizeof(a)=8
~~~

### 4.3 共用体变量存储数据的唯一性

共用体变量的不同成员虽然共用同一内存段，<u>***但内存段在一段时间内只能存放其中一个成员，而不是同时存放几个成员***</u>

这是显然的，因为在某个瞬时，内存单元中只能有唯一的内容

也就是说，~~共用体变量只能存放一个值~~   在某段时间内共用体变量只能存放一个数据

~~~C
union data
{
    int n;
    char ch;
    float f;
}a;
a.i=321;

printf("%d",a.i); //输出整数321
printf("%d",a.ch); //输出整数65
printf("%d",a.ch); //输出字符'A'
printf("%d",a.f); //输出0.000000
~~~

首先明确该共用体变量a所占用的内存大小是4字节

将321赋给 a.i 后，321会按补码形式存放在这四个字节中，321的补码是：00000000 00000000 00000001 10000001

如果用%d输出 a.i，输出结果即为321

如果用%d或%c输出 a.ch，系统会先根据该成员的类型确定需要读取的字节数，因为char型变量占用1字节，系统会把最后一个字节的内容 10000001 作为a.ch的内容来进行输出

如果用%f输出 a.f,那么系统会把这四个字节的内容全部作为float来处理，因为数值部分为0，所以输出0.000000

---

### 4.3 共用体变量存储数据的替代性

***共用体变量中起作用成员是最后一次被赋值的成员***

**在对共用体变量中的一个成员赋值后，原有内存单元中的值就会被取代** (<u>内存完全覆盖</u>)

~~~C
union data
{
    int i;
    char ch;
    float f;
}a;

a.ch='A'; 
a.f=3.14;
a.ch=97; //最后共用体变量a内存中的内容是：00000000 00000000 00000000 01100001

printf("%d",a.i); //输出97
printf("%d",a.ch); //输出97
printf("%c",a.ch); //输出'a'
printf("%f",a.f); //输出0.000000
~~~

---

## 5. 注意事项

### 5.1 共用体变量的赋值

**不能对共用体变量名赋值，也不能直接引用共用体变量名**

~~~C
a=1; //错误
int m=a; //错误
~~~

***<u>C99允许同类型的共用体变量相互赋值</u>***

注意：**只有是共用体名相同的才是同类型的共用体变量**！

​		   **即使各成员的排列顺序、类型、成员名都完全相同，都不算作同类型**！

​			不同类型的共用体变量之间如果相互赋值会报错

~~~C
union type1{
    int data;
    char ch;
}a={0},b={1};

union type2{
    int data;
    char ch;
}c={2};

a=b; //正确
a=c; //错误，type1和type2是两个不同的共用体变量类型
~~~

---

在之前共用体变量是不能用作函数参数的，C99允许使用共用体变量作函数参数

可以定义指向共用体变量的指针变量

可以定义共用体数组，数组中的每个元素都是一个共用体变量

共用体变量可以作为结构体变量的成员，结构体变量也可以作为共用体变量的成员